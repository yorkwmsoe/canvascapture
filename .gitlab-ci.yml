stages:
    - ğŸ‹ docker
    - ğŸ› install
    - âœ… check
    - ğŸ¤ test
    - ğŸ“¦ build
    - ğŸš€ release

variables:
    CLI_BASE_PATH: apps/cli
    DESKTOP_BASE_PATH: apps/desktop
    CI_REGISTRY_IMAGE_PATH: $CI_REGISTRY_IMAGE
    CI_PIPELINE_ID: $CI_PIPELINE_ID
    BASE_IMAGE: $CI_REGISTRY_IMAGE_PATH/base:$CI_PIPELINE_ID
    CLI_IMAGE: $CI_REGISTRY_IMAGE_PATH/cli:$CI_PIPELINE_ID
    DESKTOP_IMAGE: $CI_REGISTRY_IMAGE_PATH/desktop:$CI_PIPELINE_ID

include:
    - local: .docker-ci.yml
    - local: /apps/cli/.gitlab-ci.yml
    - local: /apps/desktop/.gitlab-ci.yml

install-packages:
    image: $BASE_IMAGE
    stage: ğŸ› install
    needs:
        - job: build-docker-base
          optional: true
    script:
        # Install packages for all apps
        - pnpm install
        # Build packages for all apps
        - pnpm package
        # Symlink packages for all apps
        - pnpm install
    artifacts:
        paths:
            - /**/node_modules/
            - packages/*/dist/

check-format:
    image: $BASE_IMAGE
    needs: ['install-packages']
    stage: âœ… check
    script:
        - pnpm format:check

check-lint:
    image: $BASE_IMAGE
    needs: ['install-packages']
    stage: âœ… check
    script:
        - pnpm lint
