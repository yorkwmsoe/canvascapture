stages:
  - ğŸ‹ docker
  - ğŸ› install
  - ğŸ¤ test
  - ğŸ“¦ build
  - ğŸš€ release

variables:
  CLI_BASE_PATH: apps/cli
  DESKTOP_BASE_PATH: apps/desktop

include:
  - local: /apps/cli/.gitlab-ci.yml
  - local: /apps/desktop/.gitlab-ci.yml

install-packages:
  image: $CI_REGISTRY_IMAGE/base
  stage: ğŸ› install
  needs:
    - job: build-docker-base
      optional: true
  script:
    - pnpm install
  artifacts:
    paths:
      - node_modules/
      - $DESKTOP_BASE_PATH/node_modules/
      - $CLI_BASE_PATH/node_modules/

build-docker-base:
  stage: ğŸ‹ docker
  image: docker:stable
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build . -t $CI_REGISTRY_IMAGE/base
    - docker push $CI_REGISTRY_IMAGE/base
  only:
    changes:
      - Dockerfile

build-docker-desktop:
  stage: ğŸ‹ docker
  image: docker:stable
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build . -f $DESKTOP_BASE_PATH/Dockerfile -t $CI_REGISTRY_IMAGE/desktop
    - docker push $CI_REGISTRY_IMAGE/desktop
  only:
    changes:
      - $DESKTOP_BASE_PATH/Dockerfile

build-docker-cli:
    stage: ğŸ‹ docker
    image: docker:stable
    services:
        - docker:dind
    script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker build . -f $CLI_BASE_PATH/Dockerfile -t $CI_REGISTRY_IMAGE/cli
        - docker push $CI_REGISTRY_IMAGE/cli
    only:
      changes:
        - $CLI_BASE_PATH/Dockerfile